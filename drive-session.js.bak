const fs = require('fs');
const path = require('path');
const { google } = require('googleapis');
require('dotenv').config();

const KEYFILEPATH = process.env.GOOGLE_SERVICE_ACCOUNT_PATH || 'google-service-account.json';
const SCOPES = ['https://www.googleapis.com/auth/drive.file'];

const auth = new google.auth.GoogleAuth({
  keyFile: KEYFILEPATH,
  scopes: SCOPES
});

const drive = google.drive({ version: 'v3', auth });

const SESSION_FILE_PATH = path.join(__dirname, 'auth_info.json');
const DRIVE_FOLDER_ID = process.env.DRIVE_FOLDER_ID;

async function saveSession() {
  // ⛔ Jangan upload kalau belum ada filenya
  if (!fs.existsSync(SESSION_FILE_PATH)) {
    console.error('❌ Session file not found yet, try again after a few seconds.');
    return;
  }

  const fileMetadata = {
    name: 'auth_info.json',
    parents: [DRIVE_FOLDER_ID]
  };

  const media = {
    mimeType: 'application/json',
    body: fs.createReadStream(SESSION_FILE_PATH)
  };

  try {
    const res = await drive.files.create({
      resource: fileMetadata,
      media,
      fields: 'id'
    });
    console.log('✅ Session uploaded to Drive. File ID:', res.data.id);
  } catch (err) {
    console.error('❌ Failed to upload session:', err.message);
  }
}

module.exports = {
  saveSession
};
